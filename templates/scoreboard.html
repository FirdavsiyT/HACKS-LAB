{% extends 'base.html' %}
{% load static %}

{% block header_title %}scoreboard{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto fade-in">

{% if leaderboard_data %}
    <!-- График активности (Linux Style) -->
    <h2 class="text-xl font-bold text-white mb-5 flex items-center gap-3">
        <div class="w-1 h-6 bg-[#9fef00] shadow-[0_0_10px_rgba(159,239,0,0.5)]"></div>
        Score Metrics <span class="text-[#5a6278] text-sm font-mono font-normal ml-2">// Top 10 Active</span>
    </h2>
    <div class="glass-panel rounded-xl overflow-hidden border border-[#2c2f3b] mb-12">
        <!-- Terminal Header -->
        <div class="p-4 border-b border-[#2c2f3b] bg-[#15171e] flex items-center gap-3">
            <div class="flex gap-1.5">
                <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/50"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/50"></div>
            </div>
            <div class="flex-1 flex items-center justify-between">
                <!-- ДОБАВЛЕНО: watch -n 5 -->
                <span class="text-xs text-[#5a6278] font-mono ml-2">watch -n 5 "./score_progression.sh --top 10"</span>
                <span class="text-[10px] text-[#9fef00] font-mono border border-[#9fef00]/20 bg-[#9fef00]/10 px-2 py-0.5 rounded tracking-wider animate-pulse">LIVE_UPDATE</span>
            </div>
        </div>
        <!-- Chart Container -->
        <div class="p-6 bg-[#0d0e12]/50">
            <div class="relative h-[300px] w-full">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Таблица лидеров (Linux Style) -->
    <h2 class="text-xl font-bold text-white mb-5 flex items-center gap-3">
        <div class="w-1 h-6 bg-[#9fef00] shadow-[0_0_10px_rgba(159,239,0,0.5)]"></div>
        Top Hackers <span class="text-[#5a6278] text-sm font-mono font-normal ml-2">// Leaderboard Limit: 50</span>
    </h2>
    <div class="glass-panel rounded-xl overflow-hidden border border-[#2c2f3b] shadow-2xl">
        <!-- Terminal Header -->
        <div class="p-4 border-b border-[#2c2f3b] bg-[#15171e] flex items-center gap-3">
            <div class="flex gap-1.5">
                <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/50"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/50"></div>
            </div>
            <div class="flex-1 flex items-center justify-between">
                <!-- ДОБАВЛЕНО: watch -n 5 -->
                <span class="text-xs text-[#5a6278] font-mono ml-2">watch -n 5 "cat /etc/shadow/leaderboard | head -n 50"</span>
                <span class="text-[10px] text-[#5a6278] font-mono border border-[#2c2f3b] bg-[#1a1c23] px-2 py-0.5 rounded tracking-wider">READ-ONLY</span>
            </div>
        </div>

        <!-- Table Content -->
        <div class="overflow-x-auto bg-[#0d0e12]/30">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-[#5a6278] uppercase text-[10px] font-bold tracking-widest border-b border-[#2c2f3b]">
                        <th class="p-4 w-16 text-center font-mono">UID</th>
                        <th class="p-4 font-mono">USER</th>
                        <th class="p-4 text-center font-mono">FLAGS</th>
                        <th class="p-4 text-right font-mono">SCORE</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body" class="divide-y divide-[#2c2f3b]/50">
                    {% for player in leaderboard_data %}
                    <tr class="group transition-colors hover:bg-[#9fef00]/5 {% if player.isMe %}bg-[#9fef00]/10 border-l-2 border-l-[#9fef00]{% endif %}">
                        <td class="p-4 text-center font-mono text-[#5a6278] group-hover:text-white transition-colors">
                            {% if player.rank == 1 %}
                                <span class="text-yellow-400">#1</span>
                            {% elif player.rank == 2 %}
                                <span class="text-gray-400">#2</span>
                            {% elif player.rank == 3 %}
                                <span class="text-amber-700">#3</span>
                            {% else %}
                                <span class="opacity-50">#{{ player.rank }}</span>
                            {% endif %}
                        </td>
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-[#1a1c23] border border-[#2c2f3b] overflow-hidden group-hover:border-[#9fef00]/30 transition-colors">
                                    <img src="{{ player.avatar }}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all">
                                </div>
                                <span class="font-bold text-sm text-white font-mono group-hover:text-[#9fef00] transition-colors tracking-tight">{{ player.user }}</span>
                                {% if player.isMe %}
                                    <span class="text-[9px] bg-[#9fef00]/20 text-[#9fef00] px-1.5 py-0.5 rounded border border-[#9fef00]/20 font-mono uppercase">root</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <span class="font-mono text-xs text-[#9ca3af] bg-[#1a1c23] px-2 py-1 rounded border border-[#2c2f3b] group-hover:border-[#9fef00]/20 group-hover:text-white transition-colors">{{ player.solved }}</span>
                        </td>
                        <td class="p-4 text-right">
                            <span class="font-bold text-white font-mono tracking-tight text-lg group-hover:text-[#9fef00] transition-colors">{{ player.points }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

{% else %}
    <!-- Empty State (Linux Style) -->
    <div class="glass-panel rounded-xl overflow-hidden border border-[#2c2f3b] mt-10">
        <!-- Terminal Header -->
        <div class="p-4 border-b border-[#2c2f3b] bg-[#15171e] flex items-center gap-3">
            <div class="flex gap-1.5">
                <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/50"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/50"></div>
            </div>
            <div class="flex-1">
                <span class="text-xs text-[#5a6278] font-mono ml-2">system_status.log</span>
            </div>
        </div>

        <div class="p-12 text-center bg-[#0d0e12]/80">
            <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-[#1a1c23] border border-[#2c2f3b] flex items-center justify-center">
                <i data-lucide="terminal" class="w-8 h-8 text-[#5a6278]"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-3 font-mono">System.Out.Empty</h2>
            <div class="text-[#5a6278] font-mono text-sm max-w-md mx-auto space-y-1 mb-8">
                <p>> query SELECT * FROM leaderboard;</p>
                <p>> 0 rows returned.</p>
                <p class="animate-pulse">> Waiting for data stream...</p>
            </div>

            <a href="{% url 'challenges' %}" class="inline-flex items-center gap-2 px-6 py-3 rounded bg-[#9fef00]/10 border border-[#9fef00]/20 text-[#9fef00] font-mono font-bold hover:bg-[#9fef00] hover:text-black transition-all">
                <span>./start_mission.sh</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </a>
        </div>
    </div>
{% endif %}

</section>

<!-- Подключение Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Данные для графика -->
{% if leaderboard_data %}
{{ graph_data|json_script:"graph-data" }}
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    let myChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        const graphDataElement = document.getElementById('graph-data');

        // Если данных нет, скрипт дальше не выполняется (график не рисуется)
        if (!graphDataElement) return;

        let graphData;
        try {
            graphData = JSON.parse(graphDataElement.textContent);
        } catch (e) {
            console.error("Error parsing graph data:", e);
            return;
        }

        const ctx = document.getElementById('scoreChart').getContext('2d');

        // Инициализация графика
        myChart = new Chart(ctx, {
            type: 'line',
            data: graphData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'uptime (seconds)',
                            color: '#5a6278',
                            font: { size: 10, family: "'JetBrains Mono', monospace" }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: {
                            color: '#5a6278',
                            font: { family: "'JetBrains Mono', monospace", size: 10 }
                        }
                    },
                    y: {
                        title: { display: false },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: {
                            color: '#5a6278',
                            font: { family: "'JetBrains Mono', monospace", size: 10 }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#9ca3af',
                            font: { family: "'JetBrains Mono', monospace", size: 11 },
                            usePointStyle: true,
                            boxWidth: 6
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(21, 23, 30, 0.9)',
                        titleColor: '#9fef00',
                        titleFont: { family: "'JetBrains Mono', monospace" },
                        bodyColor: '#c5c6c7',
                        bodyFont: { family: "'JetBrains Mono', monospace" },
                        borderColor: '#2c2f3b',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 4,
                        displayColors: true,
                        usePointStyle: true,
                        callbacks: {
                            title: function(context) {
                                return '> t=' + context[0].parsed.x + 's';
                            },
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' pts';
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                elements: {
                    line: { borderWidth: 2, tension: 0 },
                    point: { radius: 0, hoverRadius: 6 }
                }
            }
        });

        // Запуск Polling (опрос сервера каждые 5 секунд)
        startScoreboardPolling();
    });

    function startScoreboardPolling() {
        setInterval(async () => {
            try {
                const response = await fetch("{% url 'scoreboard_api' %}");
                if (!response.ok) return;

                const data = await response.json();

                // 1. Обновляем график
                if (myChart && data.graph) {
                    myChart.data = data.graph;
                    myChart.update('none'); // 'none' для плавной анимации без полного ререндера
                }

                // 2. Обновляем таблицу
                if (data.leaderboard) {
                    updateLeaderboardTable(data.leaderboard);
                }

            } catch (e) {
                console.error("Polling error:", e);
            }
        }, 5000);
    }

    function updateLeaderboardTable(users) {
        const tbody = document.getElementById('leaderboard-body');
        if (!tbody) return;

        let html = '';
        users.forEach(user => {
            let rankDisplay = `<span class="opacity-50">#${user.rank}</span>`;
            if (user.rank === 1) rankDisplay = `<span class="text-yellow-400">#1</span>`;
            else if (user.rank === 2) rankDisplay = `<span class="text-gray-400">#2</span>`;
            else if (user.rank === 3) rankDisplay = `<span class="text-amber-700">#3</span>`;

            let rowClass = 'hover:bg-[#9fef00]/5';
            let nameExtra = '';
            if (user.isMe) {
                rowClass = 'bg-[#9fef00]/10 border-l-2 border-l-[#9fef00]';
                nameExtra = `<span class="text-[9px] bg-[#9fef00]/20 text-[#9fef00] px-1.5 py-0.5 rounded border border-[#9fef00]/20 font-mono uppercase">root</span>`;
            }

            html += `
            <tr class="group transition-colors ${rowClass}">
                <td class="p-4 text-center font-mono text-[#5a6278] group-hover:text-white transition-colors">
                    ${rankDisplay}
                </td>
                <td class="p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-[#1a1c23] border border-[#2c2f3b] overflow-hidden group-hover:border-[#9fef00]/30 transition-colors">
                            <img src="${user.avatar}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all">
                        </div>
                        <span class="font-bold text-sm text-white font-mono group-hover:text-[#9fef00] transition-colors tracking-tight">${user.user}</span>
                        ${nameExtra}
                    </div>
                </td>
                <td class="p-4 text-center">
                    <span class="font-mono text-xs text-[#9ca3af] bg-[#1a1c23] px-2 py-1 rounded border border-[#2c2f3b] group-hover:border-[#9fef00]/20 group-hover:text-white transition-colors">${user.solved}</span>
                </td>
                <td class="p-4 text-right">
                    <span class="font-bold text-white font-mono tracking-tight text-lg group-hover:text-[#9fef00] transition-colors">${user.points}</span>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }
</script>
{% endblock %}