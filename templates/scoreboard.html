{% extends 'base.html' %}

{% block header_title %}scoreboard{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto fade-in">

    <!-- График активности -->
    <div class="glass-panel p-6 rounded-xl border border-[#2c2f3b] mb-10">
        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
            <i data-lucide="timer" class="w-5 h-5 text-[#9fef00]"></i> Score Progression (Relative Time)
        </h3>
        <div class="relative h-[300px] w-full">
            <canvas id="scoreChart"></canvas>
        </div>
    </div>

    <!-- Таблица лидеров -->
    <div class="glass-panel overflow-hidden rounded-xl border border-[#2c2f3b] shadow-2xl">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-[#15171e] text-[#5a6278] uppercase text-[10px] font-bold tracking-widest border-b border-[#2c2f3b]">
                        <th class="p-4 w-16 text-center">#</th>
                        <th class="p-4">User</th>
                        <th class="p-4 text-center">Solves</th>
                        <th class="p-4 text-right">Score</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-[#2c2f3b]">
                    {% for player in leaderboard_data %}
                    <tr class="group transition-colors hover:bg-white/5 {% if player.isMe %}bg-[#9fef00]/10 border-l-2 border-l-[#9fef00]{% endif %}">
                        <td class="p-4 text-center font-mono text-[#5a6278] group-hover:text-white transition-colors">
                            {% if player.rank == 1 %}
                                <i data-lucide="crown" class="w-5 h-5 text-yellow-400 mx-auto fill-current"></i>
                            {% elif player.rank == 2 %}
                                <i data-lucide="medal" class="w-5 h-5 text-gray-400 mx-auto fill-current"></i>
                            {% elif player.rank == 3 %}
                                <i data-lucide="medal" class="w-5 h-5 text-amber-700 mx-auto fill-current"></i>
                            {% else %}
                                {{ player.rank }}
                            {% endif %}
                        </td>
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-[#1a1c23] border border-[#2c2f3b] overflow-hidden">
                                    <img src="{{ player.avatar }}" class="w-full h-full object-cover">
                                </div>
                                <span class="font-bold text-sm text-white group-hover:text-[#9fef00] transition-colors">{{ player.user }}</span>
                                {% if player.isMe %}
                                    <span class="text-[10px] bg-[#9fef00]/20 text-[#9fef00] px-1.5 py-0.5 rounded font-bold uppercase tracking-wide">YOU</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <span class="font-mono text-sm text-[#9ca3af] bg-[#1a1c23] px-2 py-1 rounded border border-[#2c2f3b]">{{ player.solved }}</span>
                        </td>
                        <td class="p-4 text-right">
                            <span class="font-bold text-white font-mono tracking-tight text-lg group-hover:text-[#9fef00] transition-colors">{{ player.points }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Подключение Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Данные для графика -->
{{ graph_data_json|json_script:"graph-data" }}

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const graphDataElement = document.getElementById('graph-data');
        if (!graphDataElement) return;

        let rawContent = graphDataElement.textContent;
        let graphData;

        try {
            graphData = JSON.parse(rawContent);
            if (typeof graphData === 'string') {
                graphData = JSON.parse(graphData);
            }
        } catch (e) {
            console.error("Error parsing graph data:", e);
            return;
        }

        const ctx = document.getElementById('scoreChart').getContext('2d');

        new Chart(ctx, {
            type: 'line', // Используем Line Chart, но с числовой осью X
            data: graphData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear', // ВАЖНО: Линейная шкала для времени
                        title: {
                            display: true,
                            text: 'Time (Hours from start)',
                            color: '#5a6278',
                            font: { size: 10, family: "'JetBrains Mono', monospace" }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: {
                            color: '#5a6278',
                            font: { family: "'JetBrains Mono', monospace", size: 10 }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Total Score',
                            color: '#5a6278',
                            font: { size: 10, family: "'JetBrains Mono', monospace" }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: {
                            color: '#5a6278',
                            font: { family: "'JetBrains Mono', monospace", size: 10 }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#9ca3af',
                            font: { family: "'Inter', sans-serif", size: 11, weight: 'bold' },
                            usePointStyle: true,
                            boxWidth: 6
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1c23',
                        titleColor: '#fff',
                        bodyColor: '#9ca3af',
                        borderColor: '#2c2f3b',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: true,
                        usePointStyle: true,
                        callbacks: {
                            title: function(context) {
                                return 'Time: ' + context[0].parsed.x + 'h';
                            },
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' pts';
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
            }
        });
    });
</script>
{% endblock %}