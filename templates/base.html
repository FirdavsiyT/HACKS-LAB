{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HACKLABS // {% block title %}CTF Platform{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #9fef00;
            --dark-bg: #0b0c10;
            --panel-bg: #1f2833;
            --text-gray: #c5c6c7;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0c10;
            color: #ffffff;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(159, 239, 0, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(159, 239, 0, 0.05) 0%, transparent 25%);
            min-height: 100vh;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: rgba(31, 40, 51, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glitch-hover:hover {
            animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
            color: var(--neon-green);
        }
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0b0c10; }
        ::-webkit-scrollbar-thumb { background: #1f2833; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9fef00; }

        .nav-link.active {
            color: #9fef00;
            background: rgba(159, 239, 0, 0.1);
            border-color: rgba(159, 239, 0, 0.2);
        }

        .text-glow {
            text-shadow: 0 0 10px rgba(159, 239, 0, 0.5);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* FIX: Убираем белый фон автозаполнения */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #13141b inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 border-b border-white/5 bg-[#0b0c10]/80 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <a href="{% url 'dashboard' %}" class="flex items-center gap-2 group">
                    <div class="w-8 h-8 bg-[#9fef00] flex items-center justify-center rounded font-bold text-black font-mono text-xl group-hover:scale-110 transition-transform duration-300">
                        H
                    </div>
                    <span class="font-bold text-xl tracking-tight glitch-hover">HACKLABS</span>
                </a>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-1">
                    {% if user.is_authenticated %}
                        <a href="{% url 'dashboard' %}" class="nav-link px-4 py-2 rounded-md text-sm font-medium text-[#c5c6c7] hover:text-white transition-all border border-transparent hover:border-white/5 {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                            Dashboard
                        </a>
                        <a href="{% url 'challenges' %}" class="nav-link px-4 py-2 rounded-md text-sm font-medium text-[#c5c6c7] hover:text-white transition-all border border-transparent hover:border-white/5 {% if request.resolver_match.url_name == 'challenges' %}active{% endif %}">
                            Challenges
                        </a>
                        <a href="{% url 'scoreboard' %}" class="nav-link px-4 py-2 rounded-md text-sm font-medium text-[#c5c6c7] hover:text-white transition-all border border-transparent hover:border-white/5 {% if request.resolver_match.url_name == 'scoreboard' %}active{% endif %}">
                            Scoreboard
                        </a>
                    {% endif %}
                </div>

                <!-- User Profile & Logout -->
                <div class="hidden md:flex items-center gap-4">
                    {% if user.is_authenticated %}
                        <div class="flex items-center gap-3 pl-4 border-l border-white/10">
                            <div class="text-right">
                                <div class="text-xs text-[#5a6278] uppercase font-bold tracking-wider">Operator</div>
                                <div class="text-sm font-bold text-white leading-none">{{ user.username }}</div>
                            </div>
                            <a href="{% url 'profile' %}" class="w-10 h-10 rounded-lg overflow-hidden border border-white/10 hover:border-[#9fef00] transition-colors relative group">
                                <img src="{{ user.avatar_url }}" alt="Profile" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-[#9fef00]/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            </a>
                            <!-- Logout Button (Red Power Button) -->
                            <form method="post" action="{% url 'logout' %}" class="ml-2">
                                {% csrf_token %}
                                <button type="submit" class="w-10 h-10 rounded-lg flex items-center justify-center border border-red-500/20 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-all group" title="Logout">
                                    <i data-lucide="power" class="w-5 h-5"></i>
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <a href="{% url 'login' %}" class="text-sm font-bold text-[#9fef00] hover:text-white transition-colors">LOGIN</a>
                    {% endif %}
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-white hover:text-[#9fef00]">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-[#0b0c10] border-b border-white/5">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                 {% if user.is_authenticated %}
                     <a href="{% url 'dashboard' %}" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-white/5 {% if request.resolver_match.url_name == 'dashboard' %}text-[#9fef00]{% endif %}">Dashboard</a>
                     <a href="{% url 'challenges' %}" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-white/5 {% if request.resolver_match.url_name == 'challenges' %}text-[#9fef00]{% endif %}">Challenges</a>
                     <a href="{% url 'scoreboard' %}" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-white/5 {% if request.resolver_match.url_name == 'scoreboard' %}text-[#9fef00]{% endif %}">Scoreboard</a>
                     <a href="{% url 'profile' %}" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-white/5">Profile</a>
                     <!-- Mobile Logout -->
                     <form method="post" action="{% url 'logout' %}" class="block px-3 py-2">
                        {% csrf_token %}
                        <button type="submit" class="flex items-center w-full text-left text-base font-medium text-red-500 hover:text-red-400">
                            <i data-lucide="power" class="w-4 h-4 mr-2"></i> Logout
                        </button>
                     </form>
                 {% else %}
                     <a href="{% url 'login' %}" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-white/5">Login</a>
                 {% endif %}
            </div>
        </div>
    </nav>

    <!-- breadcrumbs (Визуальные, статичные) -->
    {% block header %}
    <header class="py-6 md:py-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tighter uppercase font-mono flex flex-wrap items-center gap-2">
                <!-- Статичная часть пути -->
                <span class="text-[#5a6278]">/</span>
                <span class="text-[#5a6278]">home</span>
                <span class="text-[#5a6278]">/</span>

                <!-- Статичное имя проекта вместо username -->
                <span class="text-[#9fef00]">HACKLABS</span>

                <span class="text-[#5a6278]">/</span>

                <!-- Текущая страница -->
                <span class="text-white">{% block header_title %}Overview{% endblock %}</span>
            </h1>
        </div>
    </header>
    {% endblock %}

    <main class="flex-grow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            {% block content %}{% endblock %}
        </div>
    </main>

    <footer class="border-t border-white/5 bg-[#0b0c10] mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-5 h-5 bg-[#2c2f3b] rounded flex items-center justify-center text-[10px] text-white font-mono">H</div>
                <span class="text-xs text-[#5a6278] font-mono">HACKLABS SYSTEM v2.0</span>
            </div>
            <div class="text-xs text-[#5a6278]">
                &copy; 2024 HACKLABS. All protocols secured.
            </div>
        </div>
    </footer>

    <!-- TOAST CONTAINER (UPDATED: TOP CENTER & LARGE) -->
    <div id="toast-container" class="fixed top-8 left-0 right-0 z-[100] flex flex-col items-center gap-4 pointer-events-none px-4">
        {% if messages %}
            {% for message in messages %}
            <div class="toast-message pointer-events-auto relative w-full max-w-3xl rounded-xl border-2 shadow-[0_10px_40px_rgba(0,0,0,0.5)] flex items-center gap-5 p-6 transform transition-all duration-500 -translate-y-full opacity-0 backdrop-blur-md mb-2
                {% if message.tags == 'success' %}
                    bg-[#9fef00]/10 border-[#9fef00] text-[#9fef00]
                {% elif message.tags == 'error' %}
                    bg-red-500/10 border-red-500 text-red-500
                {% else %}
                    bg-[#2c2f3b]/95 border-[#5a6278] text-white
                {% endif %}" role="alert">

                <div class="p-3 rounded-full bg-white/5 shrink-0">
                {% if message.tags == 'success' %}
                    <i data-lucide="check-circle" class="w-8 h-8"></i>
                {% elif message.tags == 'error' %}
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                {% else %}
                    <i data-lucide="info" class="w-8 h-8"></i>
                {% endif %}
                </div>

                <div class="flex-1">
                    <h4 class="font-bold text-xs opacity-70 uppercase tracking-widest mb-1">System Notification</h4>
                    <p class="font-mono text-xl font-bold leading-tight">{{ message }}</p>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <script>
        lucide.createIcons();

        const btn = document.getElementById('mobile-menu-btn');
        const menu = document.getElementById('mobile-menu');

        if (btn && menu) {
            btn.addEventListener('click', () => {
                menu.classList.toggle('hidden');
            });
        }

        // --- Toast Logic (UPDATED FOR LARGE TOP NOTIFICATIONS) ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            let bgClass = 'bg-[#2c2f3b]/95 border-[#5a6278] text-white';
            let icon = 'info';
            let title = 'System Notification';

            if (type === 'success' || type === 'personal') {
                 bgClass = 'bg-[#9fef00]/10 border-[#9fef00] text-[#9fef00] shadow-[0_0_30px_rgba(159,239,0,0.2)]';
                 icon = 'check-circle';
                 title = 'Personal Message';
            } else if (type === 'broadcast') {
                 bgClass = 'bg-[#00d2ff]/10 border-[#00d2ff] text-[#00d2ff] shadow-[0_0_30px_rgba(0,210,255,0.2)]';
                 icon = 'radio';
                 title = 'Global Broadcast';
            } else if (type === 'error') {
                 bgClass = 'bg-red-500/10 border-red-500 text-red-500 shadow-[0_0_30px_rgba(239,68,68,0.2)]';
                 icon = 'alert-triangle';
                 title = 'System Alert';
            }

            // Start hidden above (-translate-y-full)
            toast.className = `toast-message pointer-events-auto relative w-full max-w-3xl rounded-xl border-2 shadow-[0_10px_40px_rgba(0,0,0,0.5)] flex items-center gap-5 p-6 transform transition-all duration-500 -translate-y-full opacity-0 backdrop-blur-md mb-2 ${bgClass}`;

            toast.innerHTML = `
                <div class="p-3 rounded-full bg-white/5 shrink-0">
                    <i data-lucide="${icon}" class="w-8 h-8"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-xs opacity-70 uppercase tracking-widest mb-1">${title}</h4>
                    <p class="font-mono text-xl font-bold leading-tight break-words">${message}</p>
                </div>
            `;

            container.appendChild(toast);
            lucide.createIcons();

            // Animate In (Slide Down)
            requestAnimationFrame(() => {
                toast.classList.remove('-translate-y-full', 'opacity-0');
            });

            // Remove after 7 seconds (Increased time for larger text)
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-full'); // Slide back up
                setTimeout(() => toast.remove(), 500);
            }, 7000);
        }

        // Handle initial server-side toasts
        document.addEventListener('DOMContentLoaded', () => {
            const toasts = document.querySelectorAll('.toast-message');
            toasts.forEach((toast, index) => {
                setTimeout(() => {
                    toast.classList.remove('-translate-y-full', 'opacity-0'); // Show
                }, 100 + (index * 200));

                setTimeout(() => {
                    toast.classList.add('opacity-0', '-translate-y-full'); // Hide
                    setTimeout(() => toast.remove(), 500);
                }, 7000 + (index * 500));
            });
        });

        // --- Real-time Messaging Polling ---
        {% if user.is_authenticated %}

        let seenMessages = new Set();
        try {
            const stored = sessionStorage.getItem('seen_broadcasts');
            if (stored) {
                seenMessages = new Set(JSON.parse(stored));
            }
        } catch(e) {}

        function checkMessages() {
            // Note: Use the named URL in Django templates
            fetch("{% url 'mentors:check_messages' %}")
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    let hasNewBroadcasts = false;

                    data.messages.forEach(msg => {
                        if (msg.type === 'broadcast') {
                            if (seenMessages.has(msg.id)) return;
                            seenMessages.add(msg.id);
                            hasNewBroadcasts = true;
                            showToast(msg.text, 'broadcast');
                        } else {
                            showToast(msg.text, 'personal');
                        }
                    });

                    if (hasNewBroadcasts) {
                        sessionStorage.setItem('seen_broadcasts', JSON.stringify([...seenMessages]));
                    }
                }
            })
            .catch(err => console.error("Msg poll error", err));
        }

        // Poll every 5 seconds
        setInterval(checkMessages, 5000);

        {% endif %}
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>