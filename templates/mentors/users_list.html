{% extends 'mentors/base_mentor.html' %}

{% block mentor_content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <div>
        <h2 class="text-2xl font-bold text-white">Student Management</h2>
        <p class="text-[#5a6278] text-sm">Monitor progress or reset the classroom.</p>
    </div>

    <div class="flex gap-3">
        <!-- Кнопка экспорта (только Excel) -->
        <a href="{% url 'mentors:export_users_csv' %}" class="bg-[#2c2f3b] hover:bg-white hover:text-black text-white border border-white/20 font-bold py-2 px-4 rounded text-sm flex items-center gap-2 transition-all">
            <i data-lucide="sheet" class="w-4 h-4"></i> EXPORT TO EXCEL
        </a>

        <!-- Кнопка сброса -->
        <button onclick="document.getElementById('reset-modal').classList.remove('hidden')" class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/20 font-bold py-2 px-4 rounded text-sm flex items-center gap-2 transition-all shadow-lg hover:shadow-red-500/20">
            <i data-lucide="trash-2" class="w-4 h-4"></i> RESET PLATFORM
        </button>
    </div>
</div>

<!-- Info Cards (Updated Style) -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">

    <!-- Card 1: Total Students -->
    <div class="glass-panel p-6 rounded-xl border border-[#2c2f3b] flex items-center gap-4 hover:border-[#9fef00]/50 transition-colors group shadow-lg">
        <div class="p-3 rounded-lg bg-[#9fef00]/10 text-[#9fef00] group-hover:scale-110 transition-transform">
            <i data-lucide="users" class="w-8 h-8"></i>
        </div>
        <div>
            <div class="text-[#5a6278] text-xs font-bold uppercase tracking-wider">Total Students</div>
            <div class="text-3xl font-bold text-white font-mono">{{ users|length }}</div>
        </div>
    </div>

    <!-- Card 2: Max Possible Score -->
    <div class="glass-panel p-6 rounded-xl border border-[#2c2f3b] flex items-center gap-4 hover:border-[#9fef00]/50 transition-colors group shadow-lg">
        <div class="p-3 rounded-lg bg-[#9fef00]/10 text-[#9fef00] group-hover:scale-110 transition-transform">
            <i data-lucide="trophy" class="w-8 h-8"></i>
        </div>
        <div>
            <div class="text-[#5a6278] text-xs font-bold uppercase tracking-wider">Max Possible Score</div>
            <!-- Fixed color to standard neon green -->
            <div class="text-3xl font-bold text-[#9fef00] font-mono">{{ max_possible_points }} pts</div>
            <div class="text-[10px] text-[#5a6278] font-bold mt-1">TOTAL ACTIVE POOL</div>
        </div>
    </div>

</div>

<!-- Table Container -->
<div class="glass-panel rounded-xl border border-[#2c2f3b] overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead class="bg-[#1a1c23] text-[#5a6278] font-mono text-xs uppercase">
                <tr>
                    <th class="px-4 py-3 w-16 text-center">Rank</th>
                    <th class="px-4 py-3">User</th>
                    <th class="px-4 py-3 text-right">Points</th>
                    <th class="px-4 py-3 text-right">Solved</th>
                    <th class="px-4 py-3 text-center w-1/4">Progress</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-[#2c2f3b]">
                {% for user in users %}
                <tr class="hover:bg-white/5 transition-colors group">
                    <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded bg-[#13141b] border border-[#2c2f3b] text-[#5a6278] group-hover:text-white group-hover:border-white/30 transition-all font-mono text-xs font-bold">
                            {{ forloop.counter }}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <img src="{{ user.avatar_url|default:'https://api.dicebear.com/7.x/bottts/svg?seed=default' }}" class="w-8 h-8 rounded bg-[#13141b] p-0.5 border border-[#2c2f3b]" alt="Avatar">
                            <div>
                                <div class="font-bold text-white group-hover:text-[#9fef00] transition-colors">{{ user.username }}</div>
                                <div class="text-[10px] text-[#5a6278]">{{ user.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-right font-mono">
                        <span class="text-[#9fef00] font-bold">{{ user.total_points }}</span>
                    </td>
                    <td class="px-4 py-3 text-right text-white font-mono">{{ user.solved_count }}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="flex-1 bg-[#13141b] h-1.5 rounded-full overflow-hidden border border-[#2c2f3b]">
                                <div class="h-full bg-[#9fef00] rounded-full" style="width: {{ user.percentage|stringformat:'f' }}%"></div>
                            </div>
                            <!-- UPDATED: floatformat:2 and w-12 -->
                            <span class="text-[10px] font-mono font-bold text-[#5a6278] w-12 text-right">{{ user.percentage|floatformat:2 }}%</span>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-4 py-12 text-center text-[#5a6278]">
                        <div class="flex flex-col items-center justify-center gap-2">
                            <i data-lucide="users" class="w-8 h-8 opacity-50 mb-2"></i>
                            <p>No students found. Waiting for registrations...</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reset Modal -->
<div id="reset-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-panel rounded-xl border border-red-500/30 max-w-md w-full shadow-[0_0_50px_rgba(239,68,68,0.2)] transform scale-100 transition-all overflow-hidden">
        <div class="p-6 bg-red-500/10 border-b border-red-500/20 flex items-center gap-4">
             <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center text-red-500 flex-shrink-0">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
             </div>
             <div>
                 <h3 class="text-xl font-bold text-white">DANGER ZONE</h3>
                 <p class="text-red-400 text-xs font-bold uppercase tracking-wide">Irreversible Action</p>
             </div>
        </div>

        <div class="p-6">
            <p class="text-[#9ca3af] mb-6 text-sm leading-relaxed">
                You are about to <span class="text-white font-bold">PERMANENTLY DELETE</span>:
                <br>• All student accounts
                <br>• All solved flags and points
                <br>• All submission history
                <br><br>
                <span class="text-xs italic opacity-70">Challenges and Categories will NOT be deleted.</span>
            </p>

            <form action="{% url 'mentors:reset_platform' %}" method="post" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-[10px] font-bold text-[#5a6278] uppercase mb-2 tracking-wider">Type "CONFIRM_RESET" to proceed</label>
                    <input type="text" name="confirm" required class="w-full bg-[#13141b] border border-red-500/50 rounded p-3 text-white focus:outline-none focus:border-red-500 text-center font-mono placeholder-[#5a6278] text-sm" placeholder="CONFIRM_RESET">
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="document.getElementById('reset-modal').classList.add('hidden')" class="flex-1 py-3 rounded bg-[#2c2f3b] text-white hover:bg-[#3f4454] transition-colors font-bold text-sm border border-white/5">CANCEL</button>
                    <button type="submit" class="flex-1 py-3 rounded bg-red-600 text-white hover:bg-red-700 transition-colors font-bold text-sm shadow-lg shadow-red-600/20 border border-red-500/50">RESET EVERYTHING</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}