{% extends 'mentors/base_mentor.html' %}

{% block mentor_content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <div>
        <h2 class="text-2xl font-bold text-white">Student Management</h2>
        <p class="text-[#5a6278] text-sm">Monitor progress or reset the classroom.</p>
    </div>

    <div class="flex gap-3">
        <!-- Кнопка экспорта (только Excel) -->
        <a href="{% url 'mentors:export_users_csv' %}" class="bg-[#2c2f3b] hover:bg-white hover:text-black text-white border border-white/20 font-bold py-2 px-4 rounded text-sm flex items-center gap-2 transition-all">
            <i data-lucide="sheet" class="w-4 h-4"></i> EXPORT TO EXCEL
        </a>

        <!-- Кнопка сброса -->
        <button onclick="document.getElementById('reset-modal').classList.remove('hidden')" class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/20 font-bold py-2 px-4 rounded text-sm flex items-center gap-2 transition-all shadow-lg hover:shadow-red-500/20">
            <i data-lucide="trash-2" class="w-4 h-4"></i> RESET PLATFORM
        </button>
    </div>
</div>

<!-- Info Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-[#1a1d26] p-6 rounded-lg border border-white/5 shadow-xl">
        <div class="text-[#5a6278] text-xs font-bold uppercase mb-2">Total Students</div>
        <div class="text-3xl font-bold text-white">{{ users|length }}</div>
    </div>

    <div class="bg-[#1a1d26] p-6 rounded-lg border border-white/5 shadow-xl">
        <div class="text-[#5a6278] text-xs font-bold uppercase mb-2">Max Possible Score</div>
        <div class="text-3xl font-bold text-emerald-400">{{ max_possible_points }} pts</div>
        <div class="text-xs text-[#5a6278] mt-1">Sum of all active challenges</div>
    </div>
</div>

<div class="bg-[#1a1d26] border border-white/5 rounded-lg shadow-2xl overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-[#2c2f3b] border-b border-white/5">
                    <th class="p-4 text-xs font-bold text-[#5a6278] uppercase tracking-wider">Rank</th>
                    <th class="p-4 text-xs font-bold text-[#5a6278] uppercase tracking-wider">User</th>
                    <th class="p-4 text-xs font-bold text-[#5a6278] uppercase tracking-wider text-right">Points</th>
                    <th class="p-4 text-xs font-bold text-[#5a6278] uppercase tracking-wider text-right">Solved</th>
                    <th class="p-4 text-xs font-bold text-[#5a6278] uppercase tracking-wider text-center">Progress</th>
                    <!-- Удалена колонка Last Login -->
                </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
                {% for user in users %}
                <tr class="hover:bg-white/5 transition-colors group">
                    <td class="p-4 text-white font-mono text-sm">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded bg-[#13141b] border border-white/10 text-[#5a6278] group-hover:text-white group-hover:border-white/30 transition-all font-bold">
                            {{ forloop.counter }}
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="{{ user.avatar_url|default:'https://api.dicebear.com/7.x/bottts/svg?seed=default' }}" class="w-10 h-10 rounded bg-[#13141b] p-1 border border-white/10" alt="Avatar">
                            <div>
                                <div class="font-bold text-white group-hover:text-blue-400 transition-colors">{{ user.username }}</div>
                                <div class="text-xs text-[#5a6278]">{{ user.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-right">
                        <span class="text-emerald-400 font-bold">{{ user.total_points }}</span>
                    </td>
                    <td class="p-4 text-right text-white font-mono">{{ user.solved_count }}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-1 bg-[#13141b] h-2 rounded-full overflow-hidden border border-white/5">
                                <div class="h-full bg-emerald-500 rounded-full" style="width: {{ user.percentage|stringformat:'f' }}%"></div>
                            </div>
                            <span class="text-xs font-bold text-[#5a6278] w-12 text-right">{{ user.percentage|floatformat:1 }}%</span>
                        </div>
                    </td>
                    <!-- Удалена ячейка Last Login -->
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="p-12 text-center text-[#5a6278]">
                        <div class="flex flex-col items-center justify-center gap-4">
                            <i data-lucide="users" class="w-12 h-12 opacity-20"></i>
                            <p>No students found. Waiting for registrations...</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reset Modal -->
<div id="reset-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-[#1a1d26] border border-red-500/30 rounded-lg max-w-md w-full shadow-2xl shadow-red-900/20 transform scale-100 transition-all">
        <div class="p-6">
            <div class="flex items-center gap-3 text-red-500 mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                <h3 class="text-xl font-bold">DANGER ZONE</h3>
            </div>

            <p class="text-[#8b9bb4] mb-6 leading-relaxed">
                You are about to <span class="text-white font-bold">PERMANENTLY DELETE</span>:
                <br>1. All student accounts
                <br>2. All solved flags and points
                <br>3. All submission history
                <br><br>
                This is typically done before starting a new class. Challenges and Categories will NOT be deleted.
            </p>

            <form action="{% url 'mentors:reset_platform' %}" method="post" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-xs font-bold text-[#5a6278] uppercase mb-2">Type "CONFIRM_RESET" to proceed</label>
                    <input type="text" name="confirm" required class="w-full bg-[#13141b] border border-red-500/50 rounded p-3 text-white focus:outline-none focus:border-red-500 text-center font-mono placeholder-gray-700" placeholder="CONFIRM_RESET">
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="document.getElementById('reset-modal').classList.add('hidden')" class="flex-1 py-3 rounded bg-[#2c2f3b] text-white hover:bg-[#3f4454] transition-colors font-bold text-sm">CANCEL</button>
                    <button type="submit" class="flex-1 py-3 rounded bg-red-600 text-white hover:bg-red-700 transition-colors font-bold text-sm shadow-lg shadow-red-600/20">RESET EVERYTHING</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}