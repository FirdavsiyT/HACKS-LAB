{% extends 'mentors/base_mentor.html' %}

{% block mentor_content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">

    <!-- Timer Control Panel -->
    <div class="glass-panel p-6 rounded-xl border border-[#2c2f3b] lg:col-span-3 relative overflow-hidden transition-all duration-300">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6 border-b border-[#2c2f3b] pb-4">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <i data-lucide="timer" class="w-6 h-6 text-[#9fef00]"></i>
                Lesson Timer
            </h3>
            {% if lesson_settings.end_time %}
            <div class="flex items-center gap-2">
                <span class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#9fef00] opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-[#9fef00]"></span>
                </span>
                <span class="text-[#9fef00] font-bold text-xs tracking-wider uppercase">Active</span>
            </div>
            {% else %}
            <div class="text-[#5a6278] font-bold text-xs tracking-wider uppercase">Inactive</div>
            {% endif %}
        </div>

        {% if lesson_settings.end_time %}
            <!-- MODE 1: ACTIVE DISPLAY (Visible by default when timer is running) -->
            <div id="timer-view-mode" class="animate-in fade-in slide-in-from-left-2 duration-300">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Start Info -->
                    <div class="p-4 rounded-lg bg-[#1a1c23] border border-[#2c2f3b] flex items-center justify-between">
                         <div>
                            <div class="text-[#5a6278] text-xs font-bold uppercase mb-1">Started At</div>
                            <div class="text-xl font-mono text-[#9ca3af] font-bold">
                                {% if lesson_settings.start_time %}
                                    {{ lesson_settings.start_time|date:"H:i" }}
                                {% else %}
                                    --:--
                                {% endif %}
                            </div>
                        </div>
                        <div class="p-2 rounded bg-[#2c2f3b] text-[#5a6278]">
                            <i data-lucide="play-circle" class="w-5 h-5"></i>
                        </div>
                    </div>

                    <!-- End Info -->
                    <div class="p-4 rounded-lg bg-[#1a1c23] border border-[#2c2f3b] flex items-center justify-between group hover:border-[#9fef00]/30 transition-colors">
                        <div>
                            <div class="text-[#5a6278] text-xs font-bold uppercase mb-1">Target End</div>
                            <div class="text-2xl font-mono text-white font-bold">{{ lesson_settings.end_time|date:"H:i" }}</div>
                        </div>
                        <div class="p-2 rounded bg-[#9fef00]/10 text-[#9fef00]">
                            <i data-lucide="clock" class="w-6 h-6"></i>
                        </div>
                    </div>

                    <!-- Hard Deadline Info -->
                    <div class="p-4 rounded-lg bg-[#1a1c23] border border-[#2c2f3b] flex items-center justify-between group hover:border-red-500/30 transition-colors">
                        <div>
                            <div class="text-[#5a6278] text-xs font-bold uppercase mb-1">Hard Stop (Lock)</div>
                            <div class="text-2xl font-mono text-red-400 font-bold">
                                {% if lesson_settings.hard_deadline %}
                                    {{ lesson_settings.hard_deadline|date:"H:i" }}
                                {% else %}
                                    <span class="text-[#5a6278]">None</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="p-2 rounded bg-red-500/10 text-red-500">
                            <i data-lucide="lock" class="w-6 h-6"></i>
                        </div>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="flex gap-3">
                    <button onclick="toggleTimerEdit(true)" class="px-6 py-2 rounded bg-[#2c2f3b] text-white hover:bg-white hover:text-black font-bold border border-white/20 transition-all flex items-center gap-2">
                        <i data-lucide="edit-3" class="w-4 h-4"></i> CHANGE DURATION
                    </button>

                    <form method="post" class="inline-block" onsubmit="return confirm('Are you sure you want to stop the lesson?');">
                        {% csrf_token %}
                        <button type="submit" name="reset_timer" class="px-6 py-2 rounded bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white font-bold border border-red-500/20 transition-all flex items-center gap-2">
                            <i data-lucide="square" class="w-4 h-4 fill-current"></i> STOP LESSON
                        </button>
                    </form>
                </div>
            </div>
        {% endif %}

        <!-- MODE 2: FORM (Visible if inactive OR if "Edit" is clicked) -->
        <div id="timer-edit-mode" class="{% if lesson_settings.end_time %}hidden{% endif %} animate-in fade-in slide-in-from-right-2 duration-300">
            <form method="post" class="flex flex-col gap-6">
                {% csrf_token %}

                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-[#5a6278] uppercase mb-2">
                            Total Duration (min)
                        </label>
                        <div class="relative group">
                            {{ timer_form.duration_minutes }}
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-[#5a6278]">
                                <i data-lucide="hourglass" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <p class="text-[10px] text-[#5a6278] mt-1.5">
                            {% if lesson_settings.end_time %}
                            Adjust the TOTAL lesson length. Calculated from start time.
                            {% else %}
                            Sets the main green timer duration.
                            {% endif %}
                        </p>
                    </div>

                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-[#5a6278] uppercase mb-2">Overtime Delay (min)</label>
                        <div class="relative group">
                            {{ timer_form.delay_minutes }}
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-[#5a6278]">
                                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <p class="text-[10px] text-[#5a6278] mt-1.5">Additional red phase before lock.</p>
                    </div>
                </div>

                <div class="flex gap-3 pt-2 border-t border-[#2c2f3b]">
                    <button type="submit" name="set_timer" class="px-8 py-2.5 rounded bg-[#9fef00] text-black font-bold hover:bg-[#8cd600] transition-all flex items-center gap-2 shadow-[0_0_20px_rgba(159,239,0,0.2)]">
                        {% if lesson_settings.end_time %}
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> UPDATE DURATION
                        {% else %}
                            <i data-lucide="play" class="w-4 h-4 fill-current"></i> START LESSON
                        {% endif %}
                    </button>

                    {% if lesson_settings.end_time %}
                    <button type="button" onclick="toggleTimerEdit(false)" class="px-6 py-2.5 rounded bg-[#2c2f3b] text-[#9ca3af] hover:text-white font-bold transition-colors">
                        CANCEL
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="glass-panel p-6 rounded-xl border border-[#2c2f3b] flex items-center gap-4 hover:border-[#9fef00]/50 transition-colors group">
        <div class="p-3 rounded-lg bg-[#9fef00]/10 text-[#9fef00] group-hover:scale-110 transition-transform">
            <i data-lucide="users" class="w-8 h-8"></i>
        </div>
        <div>
            <div class="text-[#5a6278] text-xs font-bold uppercase tracking-wider">Active Students</div>
            <div class="text-3xl font-bold text-white font-mono">{{ total_users }}</div>
        </div>
    </div>

    <div class="glass-panel p-6 rounded-xl border border-[#2c2f3b] flex items-center gap-4 hover:border-[#00d2ff]/50 transition-colors group">
        <div class="p-3 rounded-lg bg-[#00d2ff]/10 text-[#00d2ff] group-hover:scale-110 transition-transform">
            <i data-lucide="flag" class="w-8 h-8"></i>
        </div>
        <div>
            <div class="text-[#5a6278] text-xs font-bold uppercase tracking-wider">Total Challenges</div>
            <div class="text-3xl font-bold text-white font-mono">{{ total_challenges }}</div>
        </div>
    </div>

    <div class="glass-panel p-6 rounded-xl border border-[#2c2f3b] flex items-center gap-4 hover:border-[#ff0055]/50 transition-colors group">
        <div class="p-3 rounded-lg bg-[#ff0055]/10 text-[#ff0055] group-hover:scale-110 transition-transform">
            <i data-lucide="check-circle" class="w-8 h-8"></i>
        </div>
        <div>
            <div class="text-[#5a6278] text-xs font-bold uppercase tracking-wider">Flags Captured</div>
            <div class="text-3xl font-bold text-white font-mono">{{ total_solves }}</div>
        </div>
    </div>

    <!-- Recent Activity Table -->
    <div class="glass-panel rounded-xl border border-[#2c2f3b] lg:col-span-3 overflow-hidden">
        <div class="p-4 border-b border-[#2c2f3b] bg-[#1a1c23] flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2">
                <i data-lucide="activity" class="w-4 h-4 text-[#9ca3af]"></i>
                Live Activity Feed
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-[#1a1c23] text-[#5a6278] font-mono text-xs uppercase">
                    <tr>
                        <th class="px-6 py-3">Time</th>
                        <th class="px-6 py-3">User</th>
                        <th class="px-6 py-3">Challenge</th>
                        <th class="px-6 py-3 text-right">Points</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-[#2c2f3b]">
                    {% for solve in recent_solves %}
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-6 py-3 font-mono text-[#5a6278]">{{ solve.date|date:"H:i:s" }}</td>
                        <td class="px-6 py-3 font-bold text-white">{{ solve.user.username }}</td>
                        <td class="px-6 py-3 text-[#9ca3af]">
                            {{ solve.challenge.title }}
                            <span class="ml-2 text-[10px] bg-[#2c2f3b] px-1.5 py-0.5 rounded border border-[#3f4454]">{{ solve.challenge.category.name }}</span>
                        </td>
                        <td class="px-6 py-3 text-right font-mono text-[#9fef00]">+{{ solve.challenge.points }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-[#5a6278]">
                            No solves recorded yet. Waiting for first blood...
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    function toggleTimerEdit(show) {
        const viewMode = document.getElementById('timer-view-mode');
        const editMode = document.getElementById('timer-edit-mode');

        if (show) {
            if(viewMode) viewMode.classList.add('hidden');
            if(editMode) editMode.classList.remove('hidden');
        } else {
            if(viewMode) viewMode.classList.remove('hidden');
            if(editMode) editMode.classList.add('hidden');
        }
    }
</script>
{% endblock %}